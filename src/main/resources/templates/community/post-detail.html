<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title th:text="${post.title} + ' - 게시글 상세보기'">게시글 상세보기</title>

    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/post-detail.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body data-page="detail"
      th:attr="data-post-id=${post.id}"
      th:data-current-user-id="${#authentication?.principal?.userId}"
      th:data-current-username="${#authentication?.name}"
      th:data-current-user-email="${#authorization.expression('isAuthenticated()') ? #authentication.principal.username : null}">

<div th:replace="~{fragments/header :: header}"></div>

<main class="main-container">
    <div class="post-detail-card" th:attr="data-post-id=${post.id}">

        <header class="post-header">
            <img class="profile-img" th:src="@{/img/profile-default.svg}" alt="프로필" />
            <div class="user-info">
                <span class="username" th:text="${post.username}">testuser</span>
                <span class="post-date"
                      th:text="${post.createdAt != null ? #temporals.format(post.createdAt, 'yyyy-MM-dd') : ''}">
                  2025-08-08
                </span>
            </div>
        </header>

        <h2 class="post-title" th:text="${post.title}">게시글 제목</h2>

        <div class="badges">
            <span class="badge badge-tech" th:text="${post.interviewType}">PRACTICE</span>
            <span class="score" th:text="${post.score} + ' 점'">0 점</span>
            <span class="grade" th:text="${post.grade != null ? '• ' + post.grade + ' 등급' : ''}">• C 등급</span>
        </div>

        <div class="post-content" th:text="${post.summary}">게시글 요약/내용</div>

        <div class="post-extra" th:if="${post.interviewResultId != null}">
            <hr class="meta-divider" />
            <div class="extra-row">
                <strong>인터뷰 결과 ID</strong>
                <span th:text="${post.interviewResultId}">123</span>
            </div>
        </div>

        <div class="post-extra" th:if="${post.score != null or post.grade != null}">
            <div class="extra-row">
                <strong>결과</strong>
                <span class="score" th:if="${post.score != null}" th:text="${post.score} + ' 점'">0 점</span>
                <span class="grade" th:if="${post.grade != null}" th:text="${post.grade + ' 등급'}">C 등급</span>
            </div>
        </div>

        <div class="post-extra"
             th:if="${post.interviewFeedback != null and !#strings.isEmpty(post.interviewFeedback)}">
            <h3 class="extra-title">상세 피드백</h3>
            <div class="extra-body"
                 th:utext="${#strings.replace(post.interviewFeedback, '\n', '<br/>')}"></div>
        </div>

        <div class="post-extra"
             th:if="${post.content != null and !#strings.isEmpty(post.content)}">
            <h3 class="extra-title">추가 메모</h3>
            <div class="extra-body"
                 th:utext="${#strings.replace(post.content, '\n', '<br/>')}"></div>
        </div>

        <div class="post-actions"
             th:if="${#authorization.expression('isAuthenticated()')}">
            <button id="btn-edit-post"  class="btn-action">수정</button>
            <button id="btn-delete-post" class="btn-action btn-danger">삭제</button>
        </div>

        <div class="post-footer">
            <div class="metrics">
                <div class="metric">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                    <span id="view-count" class="count" th:text="${post.viewCount}">0</span>
                </div>

                <button type="button" class="btn-icon btn-like"
                        data-post-id="[[${post.id}]]"
                        th:data-url="@{/api/community/posts/{id}/like(id=${post.id})}">
                    <i class="fa-solid fa-heart" aria-hidden="true"></i>
                    <span class="count" th:text="${post.likeCount}">0</span>
                </button>

                <button type="button" class="btn-icon btn-scrap"
                        data-post-id="[[${post.id}]]"
                        th:data-url="@{/api/community/posts/{id}/scrap(id=${post.id})}">
                    <i class="fa-regular fa-bookmark" aria-hidden="true"></i>
                    <span class="count" th:text="${post.scrapCount}">0</span>
                </button>
            </div>
            <hr class="meta-divider" />
        </div>

        <section class="comments-section">
            <div class="comments">
                <div class="comments__title">
                    <span>댓글</span>
                    <span class="comments__badge">
                        <span id="comment-count"
                              th:text="${comments != null ? #lists.size(comments) : 0}">0</span>개
                    </span>
                </div>

                <form id="comment-form" class="comment-form" onsubmit="return false;">
                    <textarea id="comment-input" name="content" placeholder="댓글을 입력하세요..." required></textarea>
                    <button id="comment-submit" type="button" class="btn-submit"
                            th:disabled="${#authorization.expression('!isAuthenticated()')}">등록</button>
                </form>

                <ul id="comment-list" class="comment-list"></ul>
                <button id="comment-load-more" type="button" style="display:none">더보기</button>
            </div>
        </section>

        <div class="post-detail__nav">
            <a th:href="@{/community}" id="btn-back-to-list">
                <i class="fa fa-list-ul" aria-hidden="true"></i>
                목록
            </a>
        </div>
    </div>
</main>

<script>
    (function(){
      const d = document.body.dataset;
      window.POST_ID            = d.postId ? Number(d.postId) : null;
      window.CURRENT_USER_ID    = d.currentUserId ? Number(d.currentUserId) : null;
      window.CURRENT_USERNAME   = d.currentUsername || null;
      window.CURRENT_USER_EMAIL = d.currentUserEmail || null;
    })();
</script>

<script th:src="@{/js/post-detail-comments.js}" defer></script>
</body>
</html>
